// @codekit-append "_utility.js"
// @codekit-append "_ui/_ui.js"
// @codekit-append "_ui/_ui-nav.js"
// @codekit-append "_init.js"

/*------------------------------------------------------------------
    MAIN
-------------------------------------------------------------------*/

/* **********************************************
     Begin _utility.js
********************************************** */

/*------------------------------------------------------------------
	UTILITY FUNCTIONS
-------------------------------------------------------------------*/

(function($,sr){

	// debouncing function from John Hann
	// http://unscriptable.com/index.php/2009/03/20/debouncing-javascript-methods/

	var debounce = function (func, threshold, execAsap) {

		var timeout;

		return function debounced () {

			var obj = this, args = arguments;
			function delayed () {
				if (!execAsap)
					func.apply(obj, args);
				timeout = null;
			};

			if (timeout)
				clearTimeout(timeout);
			else if (execAsap)
				func.apply(obj, args);

			timeout = setTimeout(delayed, threshold || 150);

		};
	}

	jQuery.fn[sr] = function(fn){  return fn ? this.bind('resize', debounce(fn)) : this.trigger(sr); };

})(jQuery,'smartresize');

/* **********************************************
     Begin _ui.js
********************************************** */

/*------------------------------------------------------------------
	USER INTERFACE COMPONENTS
-------------------------------------------------------------------*/

(function() {

	var $w = $(window),
		sw = document.documentElement.clientWidth,
		sh = document.documentElement.clientHeight;

		$w.smartresize(function(){
			sw = document.documentElement.clientWidth;
			sh = document.documentElement.clientHeight;
			console.log(sw, sh);
		});

		return uiFunctions = {

			site: {

				setFooterYear: function() {
					var year = new Date().getFullYear();
					$('#footer__year').text(year);
				},

				unsetColumnHeight: function(selectorArray) {

					$(document).ready(function() {

						var selectors = new Array();

						$.each(selectorArray, function(index, value){
							selectors.push($(value));
						});

						$.each(selectors, function() {
							$(this).css('height', '');
						});

					});

				},

				setColumnHeight: function(selectorArray) {

					$(document).ready(function() {

						var selectors = new Array(),
							currentTallest = 0,
							currentRowStart = 0,
							rowDivs = new Array(),
							$el,
							topPosition = 0;

						$.each(selectorArray, function(index, value){
							selectors.push($(value));
						});

						function setHeights() {

							$.each(selectors, function() {

								$el = $(this);
								topPostion = $el.position().top;

								if (currentRowStart != topPostion) {

									for (currentDiv = 0 ; currentDiv < rowDivs.length ; currentDiv++) {
										rowDivs[currentDiv].height(currentTallest);
									}

									rowDivs.length = 0;
									currentRowStart = topPostion;
									currentTallest = $el.height();
									rowDivs.push($el);

								} else {
									rowDivs.push($el);
									currentTallest = (currentTallest < $el.height()) ? ($el.height()) : (currentTallest);
								}

								for (currentDiv = 0 ; currentDiv < rowDivs.length ; currentDiv++) {
									rowDivs[currentDiv].height(currentTallest);
								}

							});
						}

						setHeights();

					});

				},

				setHeaderWaypoint: function() {

					$('body').waypoint(function(direction){

						if ( direction === 'down' ) {
							$('body').addClass('header-collapse');
						}
						else if ( direction === 'up' ){
							$('body').removeClass('header-collapse');
						}

					}, { offset: -215 } );

				},

				bindScrollToTop: function() {

					$(document).ready(function() {
						$('.primary-nav__scroll-top').on('click', function(e){
							$('html, body').animate({
								scrollTop: 0
							}, 1250);
							e.preventDefault();
						});
					});

				},

				setCatalogRequestControls: function() {

					$(document).ready(function() {

					});

				},

				cloneDesktopHeader: function() {

					$(document).ready(function() {
						$('.header-container').clone().insertAfter('.header-container').addClass('header--clone');
						uiFunctions.site.bindScrollToTop();
					});

				},

				bindLoginPageControls: function() {

					$('#login__current-user__btn, #login__create-acct__btn').on('click', function(e) {
						$(this).hide().next('form').fadeIn();
						e.preventDefault();
					});

				}

			}
		}

})();

/* **********************************************
     Begin _ui-nav.js
********************************************** */

/*!
 *
 *  Copyright (c) David Bushell | http://dbushell.com/
 *
 */
(function(window, document, undefined)
{

	// helper functions

	var trim = function(str)
	{
		return str.trim ? str.trim() : str.replace(/^\s+|\s+$/g,'');
	};

	var hasClass = function(el, cn)
	{
		return (' ' + el.className + ' ').indexOf(' ' + cn + ' ') !== -1;
	};

	var addClass = function(el, cn)
	{
		if (!hasClass(el, cn)) {
			el.className = (el.className === '') ? cn : el.className + ' ' + cn;
		}
	};

	var removeClass = function(el, cn)
	{
		el.className = trim((' ' + el.className + ' ').replace(' ' + cn + ' ', ' '));
	};

	var hasParent = function(el, id)
	{
		if (el) {
			do {
				if (el.id === id) {
					return true;
				}
				if (el.nodeType === 9) {
					break;
				}
			}
			while((el = el.parentNode));
		}
		return false;
	};

	// normalize vendor prefixes

	var doc = document.documentElement;

	var transform_prop = window.Modernizr.prefixed('transform'),
		transition_prop = window.Modernizr.prefixed('transition'),
		transition_end = (function() {
			var props = {
				'WebkitTransition' : 'webkitTransitionEnd',
				'MozTransition'    : 'transitionend',
				'OTransition'      : 'oTransitionEnd otransitionend',
				'msTransition'     : 'MSTransitionEnd',
				'transition'       : 'transitionend'
			};
			return props.hasOwnProperty(transition_prop) ? props[transition_prop] : false;
		})();

	window.App = (function()
	{

		var _init = false, app = { };

		var inner = document.getElementById('inner-wrap'),

			nav_open = false,

			nav_class = 'js-nav';


		app.init = function()
		{
			if (_init) {
				return;
			}
			_init = true;

			var closeNavEnd = function(e)
			{
				if (e && e.target === inner) {
					document.removeEventListener(transition_end, closeNavEnd, false);
				}
				nav_open = false;
			};

			app.closeNav =function()
			{
				if (nav_open) {
					// close navigation after transition or immediately
					var duration = (transition_end && transition_prop) ? parseFloat(window.getComputedStyle(inner, '')[transition_prop + 'Duration']) : 0;
					if (duration > 0) {
						document.addEventListener(transition_end, closeNavEnd, false);
					} else {
						closeNavEnd(null);
					}
				}
				removeClass(doc, nav_class);
			};

			app.openNav = function()
			{
				if (nav_open) {
					return;
				}
				addClass(doc, nav_class);
				nav_open = true;
			};

			app.toggleNav = function(e)
			{
				if (nav_open && hasClass(doc, nav_class)) {
					app.closeNav();
				} else {
					app.openNav();
				}
				if (e) {
					e.preventDefault();
				}
			};

			// open nav with main "nav" button
			document.getElementById('nav-open-btn').addEventListener('click', app.toggleNav, false);

			// close nav with main "close" button
			document.getElementById('nav-close-btn').addEventListener('click', app.toggleNav, false);

			// close nav by touching the partial off-screen content
			document.addEventListener('click', function(e)
			{
				if (nav_open && !hasParent(e.target, 'nav')) {
					e.preventDefault();
					app.closeNav();
				}
			},
			true);

			addClass(doc, 'js-ready');

		};

		return app;

	})();

	if (window.addEventListener) {
		window.addEventListener('DOMContentLoaded', window.App.init, false);
	}

})(window, window.document);


/* **********************************************
     Begin _init.js
********************************************** */

/*------------------------------------------------------------------
    INITIALIZERS: UI components
-------------------------------------------------------------------*/

uiFunctions.site.cloneDesktopHeader();

var functionCheck = jRespond([
		{
			label: 'med-lrg',
			enter: 648,
			exit: 10000
		}
	]);

	functionCheck.addFunc({
		breakpoint: '*',
		enter: function() {
			uiFunctions.site.setFooterYear();
			uiFunctions.site.bindLoginPageControls();
			uiFunctions.site.setHeaderWaypoint();
		}
	});

	functionCheck.addFunc({
		breakpoint: 'med-lrg',
		enter: function() {

			if ( $('body').hasClass('index') ) {
				uiFunctions.site.setColumnHeight(['.featured-products__grid li', '.featured-recipes__grid ul li']);
			}
			if ( $('body').hasClass('product-single') ) {
				uiFunctions.site.setColumnHeight(['.related-products__grid ul li']);
			}
			if ( $('body').hasClass('page__recipes__category') ) {
				uiFunctions.site.setColumnHeight(['.recipes__category__list li']);
			}
			if ( $('body').hasClass('page__shop') ) {
				uiFunctions.site.setColumnHeight(['.shop-products__grid li']);
			}

		},

		exit: function() {

			if ( $('body').hasClass('index') ) {
				uiFunctions.site.unsetColumnHeight(['.featured-products__grid li', '.featured-recipes__grid ul li']);
			}
			if ( $('body').hasClass('product-single') ) {
				uiFunctions.site.unsetColumnHeight(['.related-products__grid ul li']);
			}
			if ( $('body').hasClass('page__shop') ) {
				uiFunctions.site.unsetColumnHeight(['.shop-products__grid li']);
			}

		}
	});